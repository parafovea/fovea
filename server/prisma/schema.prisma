// Prisma Schema for Fovea Video Annotation Tool
// This schema defines the database structure for personas, videos, ontologies, annotations, and summaries

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

/// Persona represents an analyst or user with their own ontology and interpretations
model Persona {
  id              String   @id @default(uuid())
  name            String
  role            String
  informationNeed String
  details         String?
  isSystemGenerated Boolean @default(false)
  hidden          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ontology        Ontology?
  videoSummaries  VideoSummary[]
  annotations     Annotation[]
  apiKeys         ApiKey[]

  @@map("personas")
}

/// Ontology defines the types (entities, events, roles, relations) for a specific persona
model Ontology {
  id             String   @id @default(uuid())
  personaId      String   @unique
  persona        Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  /// JSON structure: EntityType[]
  entityTypes    Json     @default("[]")
  /// JSON structure: EventType[]
  eventTypes     Json     @default("[]")
  /// JSON structure: RoleType[]
  roleTypes      Json     @default("[]")
  /// JSON structure: RelationType[]
  relationTypes  Json     @default("[]")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("ontologies")
}

/// WorldState stores the actual instances of entities, events, locations, times, and collections
/// This is shared across all personas (personas assign types to these instances)
model WorldState {
  id                String   @id @default(uuid())

  /// JSON structure: Entity[]
  entities          Json     @default("[]")
  /// JSON structure: Event[]
  events            Json     @default("[]")
  /// JSON structure: Time[]
  times             Json     @default("[]")
  /// JSON structure: EntityCollection[]
  entityCollections Json     @default("[]")
  /// JSON structure: EventCollection[]
  eventCollections  Json     @default("[]")
  /// JSON structure: TimeCollection[]
  timeCollections   Json     @default("[]")
  /// JSON structure: OntologyRelation[]
  relations         Json     @default("[]")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("world_state")
}

/// Video represents a video file with its metadata
model Video {
  id          String   @id @default(uuid())
  filename    String   @unique
  path        String
  duration    Float?
  frameRate   Float?
  resolution  String?
  /// Additional metadata stored as JSON
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  summaries   VideoSummary[]
  annotations Annotation[]

  @@map("videos")
}

/// VideoSummary stores AI-generated or manual summaries of videos for specific personas
model VideoSummary {
  id              String   @id @default(uuid())
  videoId         String
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  personaId       String
  persona         Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  summary         String
  visualAnalysis  String?
  audioTranscript String?
  /// JSON structure for key frame data
  keyFrames       Json?
  confidence      Float?

  /// Vector embedding for semantic search (1536 dimensions for OpenAI embeddings)
  embedding       Unsupported("vector(1536)")?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([videoId, personaId])
  @@map("video_summaries")
}

/// Annotation represents a temporal-spatial annotation on a video
model Annotation {
  id          String   @id @default(uuid())
  videoId     String
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  personaId   String
  persona     Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  type        String
  label       String
  /// JSON structure for frame-level data (bounding boxes, timestamps, etc.)
  frames      Json
  confidence  Float?
  /// Source of annotation: manual, ai-assisted, automatic
  source      String   @default("manual")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("annotations")
}

/// ImportHistory tracks data imports from JSON Lines files
model ImportHistory {
  id            String   @id @default(uuid())
  filename      String
  importedBy    String?
  importOptions Json
  result        Json
  success       Boolean
  itemsImported Int
  itemsSkipped  Int
  createdAt     DateTime @default(now())

  @@map("import_history")
}

/// ApiKey stores encrypted API keys for external services (persona-level or admin-level)
model ApiKey {
  id           String    @id @default(uuid())
  personaId    String?
  persona      Persona?  @relation(fields: [personaId], references: [id], onDelete: Cascade)

  /// Provider: anthropic, openai, google, cohere, mistral, aws, azure, roboflow, cloudsight, edenai
  provider     String
  /// User-friendly label for this key
  keyName      String
  /// AES-256-GCM encrypted API key
  encryptedKey String
  /// Last 4 characters for display (e.g., "...Xy9Z")
  keyMask      String
  /// Whether this key is active
  isActive     Boolean   @default(true)
  /// Last time this key was used
  lastUsed     DateTime?
  /// Number of times this key has been used
  usageCount   Int       @default(0)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([personaId, provider])
  @@index([provider])
  @@map("api_keys")
}
